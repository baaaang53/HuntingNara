<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>$$헌팅나라$$</title>

    <!-- bootstrap including jquery -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            show_registered();
        });
        function show_registered() {
            $('#request_table').find('tr:gt(0)').remove()
            $.ajax({
                type: 'post',
                url: '/request/list/registered',
                data: {},
                success: function(data) {
                    const cols = ['TITLE', 'S_DATE', 'E_DATE', 'COST', 'CAREER','STATE', 'DETAIL'];
                    for (const row of data) {
                        row['S_DATE'] = new Date(row['S_DATE']).toLocaleDateString('ko-KR');
                        row['E_DATE'] = new Date(row['E_DATE']).toLocaleDateString('ko-KR');
                        row['DETAIL'] = '<button type="button" onclick="window.open(\'/request/detail?rNum=' + row['R_NUM'] + '\')">상세보기</button>';
                        let newTr = '<tr>';
                        for (const col of cols) {
                            newTr += '<td>' + row[col] + '</td>';
                        }
                        if (row['F_ID'] == 'admin') {
                            newTr += '<td><button type="button" onclick="apply(' + row['R_NUM'] + ')">지원하기</button></td>';
                        }
                        newTr += '</tr>';
                        $('#request_table tr:last').after(newTr);
                    }
                },
                error: function(err) {
                    console.log(err);
                    alert('오류가 발생하였습니다');
                }
            });
        }

        function show_possible() {
            $('#request_table').find('tr:gt(0)').remove()
            $.ajax({
                type: 'post',
                url: '/request/list/possible',
                data : {},
                success: function(data) {
                    const cols = ['TITLE', 'S_DATE', 'E_DATE', 'COST', 'CAREER', 'STATE', 'DETAIL'];
                    for (const row of data) {
                        row['S_DATE'] = new Date(row['S_DATE']).toLocaleDateString('ko-KR');
                        row['E_DATE'] = new Date(row['E_DATE']).toLocaleDateString('ko-KR');
                        row['DETAIL'] = '<button type="button" onclick="window.open(\'/request/detail?rNum=' + row['R_NUM'] + '\')">상세보기</button>';
                        let newTr = '<tr>';
                        for (const col of cols) {
                            newTr += '<td>' + row[col] + '</td>';
                        }
                        if (row['F_ID'] == 'admin') {
                            newTr += '<td><button type="button" onclick="apply(' + row['R_NUM'] + ')">지원하기</button></td>';
                        }
                        newTr += '</tr>';
                        $('#request_table tr:last').after(newTr);
                    }
                },
                error: function(err) {
                    console.log(err);
                    alert('오류가 발생하였습니다');
                }
            });
        }

        function apply(rNum) {
            $.ajax({
                type: 'post',
                url: '/request/apply/ask',
                data: {
                    rNum: rNum
                },
                success: function(data, status) {
                    if (data.success) {
                        alert('지원되었습니다');
                        location.reload();
                    } else {
                        alert('지원되지 않았습니다');
                    }
                },
                error: function(err) {
                    console.log(err);
                    alert('지원되지 않았습니다');
                }
            });
        }

        function sortcost() {
            var table, rows, switching, i, x, y, shouldSwitch;
            table = document.getElementById("request_table");
            switching = true;

            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[3];
                    y = rows[i + 1].getElementsByTagName("TD")[3];
                    if (parseInt(x.innerHTML) > parseInt(y.innerHTML)) {
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }

        function sortcost_rev() {
            var table, rows, switching, i, x, y, shouldSwitch;
            table = document.getElementById("request_table");
            switching = true;
            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[3];
                    y = rows[i + 1].getElementsByTagName("TD")[3];
                    if (parseInt(x.innerHTML) < parseInt(y.innerHTML)) {
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }

        function sortdate() {
            var table, rows, switching, i, x, y, shouldSwitch;
            table = document.getElementById("request_table");
            switching = true;

            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[1];
                    y = rows[i + 1].getElementsByTagName("TD")[1];
                    if (x.innerHTML > y.innerHTML) {
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }

        function sortdate_rev() {
            var table, rows, switching, i, x, y, shouldSwitch;
            table = document.getElementById("request_table");
            switching = true;
            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("TD")[1];
                    y = rows[i + 1].getElementsByTagName("TD")[1];
                    if (x.innerHTML < y.innerHTML) {
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }

    </script>
</head>
<body>
<h1 style = "text-align: center;">의뢰 지원하기</h1>
<div>
    <button type="button" onclick="show_registered();">모집중인 의뢰보기</button>
    <button type="button" onclick="show_possible();">지원가능 의뢰보기</button>
</div>
<div>
    <table id="request_table" style="width: 100%;">
        <tr>
            <th>제목</th>
            <th>시작<button onclick="sortdate();">▲</button>
                <button onclick="sortdate_rev();">▼</button></th>
            <th>종료</th>
            <th>비용 <button onclick="sortcost();">▲</button>
                <button onclick="sortcost_rev();">▼</button></th>
            <th>요구경력</th>
            <th>의뢰상태</th>
            <th>상세보기</th>
        </tr>
    </table>
</div>
</body>
</html>